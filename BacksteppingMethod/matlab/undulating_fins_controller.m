clear
%% TEST
% syms u v w freq_l  freq_r  u_dot v_dot w_dot k_1 k_r r theta delta_amp
% l=0.2;
% 
% 
% u=0.2;v=0.000;w=0;
% freq_l=1;freq_r=1;
% r=1;theta=0;
% 
% k_r = (1.1 - sqrt(1.1^2-1))/2;
% k_1 = 0.25/k_r;
% 
% delta_amp = ((v*cos(theta) + u*sin(theta))*(w + (v*cos(theta))/r + (u*sin(theta))/r) - sin(theta)*(- 0.0033815426954186658409106599427268*freq_l^3 - 0.020852261411107465105879992608326*freq_l^2 + 0.094873313582864998013052883123777*freq_l + 0.0035174082481493703185083134904851*freq_r^3 + 0.021690075473352948991502596711062*freq_r^2 - 0.098685187733320905309944735689599*freq_r + 0.013843019405318986319213199138982*u - 0.42899554758648307412383534392652*v + 0.76600512858724358264374658758681*w + 0.038891153510585708886149331814002*w*(14.2698*u + 0.0279*v - 2.4948*w - 9.2471) - 0.10469127604789574440243639126214*v*(14.2698*u + 0.0279*v - 2.4948*w - 6.5004) - 0.10469127604789574440243639126214*u*(0.1103*u - 30.9448*v - 12.8666*w + 0.2295) + 0.00041235075311243497371364872787067*w*(0.1103*u - 31.3908*v - 12.8666*w + 1.9539) + 0.0013335363028740966700662745552528) + cos(theta)*(0.015244318213058482151510350850705*freq_l^3 + 0.094003990794930902408697368536685*freq_l^2 - 0.42769798061219364102130250718869*freq_l + 0.00027554210948513411441314911133207*freq_r^3 + 0.0016991286564372783133954993997332*freq_r^2 - 0.007730670676991313587858057028349*freq_r - 0.025345119361742080894373123098773*u - 0.20561115974172128479317673650631*v - 1.6620149002076005726699470725863*w + 0.0079978554350023780116299161523576*w*(14.2698*u + 0.0279*v - 2.4948*w - 9.2471) + 0.22715051664766025758117579714989*v*(14.2698*u + 0.0279*v - 2.4948*w - 6.5004) + 0.22715051664766025758117579714989*u*(0.1103*u - 30.9448*v - 12.8666*w + 0.2295) + 0.047102639069118483068690196332175*w*(0.1103*u - 31.3908*v - 12.8666*w + 1.9539) + 0.15232924563791959304073680000068) - (k_1 + k_r)*(u*cos(theta) - v*sin(theta)) + k_1*k_r*r)/(sin(theta)*(0.00028137535869010493658179447947963*freq_l^3 - 0.0029620998404021375532349526442502*freq_l^2 + 0.0064858071053062597836688869562952*freq_l + 0.00029268061847139485240646183832866*freq_r^3 - 0.0030811127786699305273065691168235*freq_r^2 + 0.0067463975655305288382053829186714*freq_r - 0.0044497291102801212046813395710604) - cos(theta)*(- 0.0012684670552871331165032051790211*freq_l^3 + 0.01335342966602682621412164526615*freq_l^2 - 0.029238639368876313826473320548026*freq_l + 0.000022927630041651377582677144641573*freq_r^3 - 0.00024136416779115460499288316096787*freq_r^2 + 0.00052849043542491700091364886566343*freq_r + 0.0096546560945521974277808076683843))
% amp_l = 20 + delta_amp;
% amp_r = 20 - delta_amp;
% F_pec_l = 0.5*((0.9262*freq_l^3 -1.6480*freq_l^2 + 1.5960*freq_l + 0.6419)*(0.0442*amp_l - 1.5290) +  (0.1016*freq_l^3 +1.5580*freq_l^2 -2.0650*freq_l + 1.4700)*(-0.1958*amp_l +3.0170) +  (0.0535*freq_l^3 +0.7496*freq_l^2 +1.3190*freq_l + 0.3941)*(0.1191*amp_l -0.7917));
% F_pec_r = 0.5*((0.9262*freq_r^3 -1.6480*freq_r^2 + 1.5960*freq_r + 0.6419)*(0.0442*amp_r - 1.5290) +  (0.1016*freq_r^3 +1.5580*freq_r^2 -2.0650*freq_r + 1.4700)*(-0.1958*amp_r +3.0170) +  (0.0535*freq_r^3 +0.7496*freq_r^2 +1.3190*freq_r + 0.3941)*(0.1191*amp_r -0.7917));
%    
% F_pec_trust = vpa([F_pec_l+F_pec_r; 0; F_pec_r*l-F_pec_l*l],3);

%% demo

r = 5; theta=pi/5;
u=0;v=0;w=0;
l=0.2;
rs = [];
thetas = [];
dt = 0.1;
while r>0.1
    freq_l=1;freq_r=1;
    
    k_r = (1.1 - sqrt(1.1^2-1))/2;
    k_1 = 0.25/k_r;
    
    delta_amp = ((v*cos(theta) + u*sin(theta))*(w + (v*cos(theta))/r + (u*sin(theta))/r) - (k_1 + k_r)*(u*cos(theta) - v*sin(theta)) + sin(theta)*(0.0002257727298485835899988647556805*freq_l^3 + 0.0013922260951134117347617121026693*freq_l^2 - 0.0063343298981272119415949592310228*freq_l - 0.00016265658792318753083692561554261*freq_r^3 - 0.0010030208094690820806517056693944*freq_r^2 + 0.0045635293894891451305707894065252*freq_r - 0.015456343629631126236422046909208*u + 0.46549132649070170217727479567121*v - 0.043128129470788512511846875410809*w - 0.042344703539257905695690513212973*w*(14.2698*u + 0.0279*v - 2.4948*w - 9.2471) + 0.005894397751857166044151387957961*v*(14.2698*u + 0.0279*v - 2.4948*w - 6.5004) + 0.005894397751857166044151387957961*u*(0.1103*u - 18.9448*v - 1.8666*w + 0.2295) + 0.00019155693355234656916840222172851*w*(0.1103*u - 19.3908*v - 1.8666*w + 1.9539) + 0.0006194923206303509338603058513455) + cos(theta)*(0.0083971882022210479288556166824712*freq_l^3 + 0.051781207360832037111100665724552*freq_l^2 - 0.23559337890454077500655941585975*freq_l + 0.0075544062289400045078866720279269*freq_r^3 + 0.046584197710995427840192468337802*freq_r^2 - 0.21194810051092323936759594950535*freq_r - 0.028845577517443910919075654098187*u - 0.12642562159086914302312002531047*v - 0.093575866692606814656056958413335*w + 0.00050462674493905664002041331065968*w*(14.2698*u + 0.0279*v - 2.4948*w - 9.2471) + 0.012789179244014707885422173410963*v*(14.2698*u + 0.0279*v - 2.4948*w - 6.5004) + 0.012789179244014707885422173410963*u*(0.1103*u - 18.9448*v - 1.8666*w + 0.2295) + 0.048412948277410492227743578786924*w*(0.1103*u - 19.3908*v - 1.8666*w + 1.9539) + 0.15656676644771223334902144190835) + k_1*k_r*r)/(sin(theta)*(0.000018786361304754769949638192478343*freq_l^3 - 0.00019776812753471551537251844343785*freq_l^2 + 0.00043303264436678601611067874536679*freq_l + 0.000013534519564754169477910084442079*freq_r^3 - 0.00014248084277639977507732992642515*freq_r^2 + 0.00031197573081255106598465085527635*freq_r - 0.0002505316035312162635253535421519) - cos(theta)*(- 0.00069872305489129224569389288117875*freq_l^3 + 0.0073556101679047810206735481686925*freq_l^2 - 0.016105827372916316444471953179392*freq_l + 0.0006285958669806430296221839984266*freq_r^3 - 0.0066173659482083327888128292966798*freq_r^2 + 0.014489369500615678196298784875886*freq_r + 0.00054358285930765858228419545086947));
    amp_l = 20 + delta_amp;
    amp_r = 20 - delta_amp;

    syms  u_dot v_dot w_dot
    % 定义矩阵 C, D, 和 M
    a2 = -0.1103 * u + 1.9448 * v + 1.28056 * w;
    a1 = -3.1762 * u + 0.0279 * v - 2.4948 * w;
    C = [  0,           0,         -17.446*v-a2;
           0,           0,         17.446*u+a1;
           17*v+a2, -17.446*u-a1,         0];
    
    D = -[  0.5996,  2.4967, -1.9539;
          -0.3623, 11.0042,  9.2471;
           0.2295, -6.5004, -7.3168];
    
    M = [  20.6222,  -0.0279,   2.4647;
            0.1103,   23.5012, -1.28056;
           -0.1222,   .82168,   9.2795];
    % 定义速度和推力向量
    Velocity_dot = [u_dot; v_dot; w_dot];
    Velocity = [u; v; w];
    F_pec_l = 0.5*((0.9262*freq_l^3 -1.6480*freq_l^2 + 1.5960*freq_l + 0.6419)*(0.0442*amp_l - 1.5290) +  (0.1016*freq_l^3 +1.5580*freq_l^2 -2.0650*freq_l + 1.4700)*(-0.1958*amp_l +3.0170) +  (0.0535*freq_l^3 +0.7496*freq_l^2 +1.3190*freq_l + 0.3941)*(0.1191*amp_l -0.7917));
    F_pec_r = 0.5*((0.9262*freq_r^3 -1.6480*freq_r^2 + 1.5960*freq_r + 0.6419)*(0.0442*amp_r - 1.5290) +  (0.1016*freq_r^3 +1.5580*freq_r^2 -2.0650*freq_r + 1.4700)*(-0.1958*amp_r +3.0170) +  (0.0535*freq_r^3 +0.7496*freq_r^2 +1.3190*freq_r + 0.3941)*(0.1191*amp_r -0.7917));
       
    F_pec_trust = [F_pec_l+F_pec_r; 0; F_pec_r*l-F_pec_l*l];
    % 构建方程组 eq1
    eq1 = M * Velocity_dot == -(C + D) * Velocity + F_pec_trust;
    solution1 = solve(eq1, [u_dot, v_dot, w_dot]);
%     disp('加速度的解析解 (浮点形式):');
    solution1_float = structfun(@vpa, solution1, 'UniformOutput', false);
%     disp(solution1_float);
    
    % 计算 X 和 Y
    du_dot = double(solution1_float.u_dot);
    dv_dot = double(solution1_float.v_dot);
    dw_dot = double(solution1_float.w_dot);

    u = u + du_dot * dt;
    v = v + dv_dot * dt;
    w = w + dw_dot * dt;

    dr = -u*cos(theta)+v*sin(theta);
    dtheta = u/r*sin(theta) + v/r*cos(theta) + w;
    
    r = r + dr*dt;
    theta = theta + dtheta*dt;
    rs = [rs, r];
    thetas = [thetas, r];
    
end 